stages:
  - build
  - deploy

variables:
  DOCKER_IMAGE: "att"
  DOCKER_TAG: "latest"
  SERVER_USER: "root"
  SERVER_IP: "159.223.142.146"
  CONTAINER_NAME: "attc"
  DEPLOY_PATH: "/opt/att"

before_script:
  - echo "Starting GitLab Pipeline..."
  - echo "DATABASE_URL=${DATABASE_URL}" > .env
  - echo "SECRET_KEY=${SECRET_KEY}" >> .env
  - echo "TELEGRAM_TOKEN=${TELEGRAM_TOKEN}" >> .env
  - echo "TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}" >> .env
  - echo "LOGIN=${LOGIN}" >> .env
  - echo "PASSWORD=${PASSWORD}" >> .env

build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
    - docker build -t $CI_REGISTRY_IMAGE:$DOCKER_TAG .
    - docker push $CI_REGISTRY_IMAGE:$DOCKER_TAG
  artifacts:
    paths:
      - .env
    expire_in: 1 hour

deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client rsync
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $SERVER_IP >> ~/.ssh/known_hosts
  script:
    - echo "Deploying docker-compose in ~/att on server..."

    - ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "mkdir -p ~/att"

    - rsync -avz ./docker-compose.yml $SERVER_USER@$SERVER_IP:~/att/docker-compose.yml
    - rsync -avz .env $SERVER_USER@$SERVER_IP:~/att/.env

    - ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "
        cd ~/att;
        docker-compose pull;
        docker-compose down --remove-orphans;
        docker-compose up -d;
      "
  only:
    - main



